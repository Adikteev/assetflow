# assetflow

Assetflow is an asset deployment tool for node. It enables you to create powerfull asset flows easily and fast.

Assetflow is a [Grunt task][grunt] and works with **S3** out of the box. It will take care of versioning and apply solid cache-busting techniques transparently.

> If you are not familiar with Grunt check out the [Grunt's Getting Started guide][Getting Started].

## Overview

A typical deployment flow using assetflow:

* Scan assets and generate MD5 hashes.
* Create the `manifest.json` file.
* Copy all assets and rename them with their md5 hash to a temporary location.
* Perform `HEAD` operations with **S3** and compare hashes using S3's `ETAG`.
* Upload all assets that did not have a matching `ETAG`.

Optionally there are two more tasks you can perform:

* Search & replace any set of assets based on a custom keyword, i.e. `__ASSET(img/logo.jpg)`.
* Create the `clientManifest.js` file, a client optimized subset of the manifest.

## Quick Start

```shell
npm install assetflow --save-dev
```

Open your [Gruntfile][] and add the following config:

```js
  assets: {
      options: {
        manifest: 'temp/manifest.json',
      },
      all: {
        src: ['assets/**'],
        dest: 'temp/assets'
      },
    },
    assetsS3: {
      options: {
        checkS3Head: true,
        manifest: 'temp/manifest.json',
        key: config.aws_key,
        secret: config.aws_secret,
        bucket: config.aws_static_bucket,
        access: 'public-read',
      },
      target: {
        upload: {
          src: 'temp/assets/**',
          dest:  'folder/'
        }
      }
    }
```

## Grunt Task `assets`

The `assets` task performs these operations:

* Scans all the defined assets.
* Generates **md5** hashes for each asset.
* Create the `manifest.json` file.
  - If a manifest file exists, it will compare the hashes.
* Copy all new or updated assets and rename them with their md5 hash to a temporary location.

When this task finishes all your assets have been copied to a new temporary folder that you defined. This folder will contain your assets renamed with their own hash, like so:

`app.js` --> `app-h522md41d.js`

The `manifest.json` file generated by this task keeps a reference to all your assets so their names can be properly resolved in all environments.

### Options

#### `manifest`
**Type**: `string` **Default**: `manifest.json`

Define the location of the manifest file.

#### `cdnurl`
**Type**: `string` **Default**: *none*

Add the url of your CDN to prepend it to all assets.

#### `truncateHash`
**Type**: `number` **Default**: *none*

The **md5** hash is 32 bytes long, you don't need all of it, use this option to truncate the hash down to *n* chars.

#### `maxOperations`
**Type**: `number` **Default**: `100`

The maximum number of concurent operations, in this case the operations are file copying.


**Type**: `string` **Default**: *none*
**Type**: `string` **Default**: *none*


The assets task will scan all the defined assets, generate md5 hashes, create the `manifest.json` file and copy all the assets to a temporary location renamed with their md5 hash.

## Release History
- **v0.1.0**, *Mid March 2013*
  - Big Bang


[grunt]: http://gruntjs.com/
[Getting Started]: https://github.com/gruntjs/grunt/wiki/Getting-started
[package.json]: https://npmjs.org/doc/json.html
[DOMContentLoaded]: https://developer.mozilla.org/en-US/docs/Mozilla_event_reference/DOMContentLoaded_(event) "MDN DOMContentLoaded event"
[mantriDeps]: https://github.com/thanpolas/mantri/wiki/Grunt-Task-mantriDeps "The mantriDeps grunt task"
[mantriBuild]: https://github.com/thanpolas/mantri/wiki/Grunt-Task-mantriBuild "The mantriBuild grunt task"
[Gruntfile]: https://github.com/gruntjs/grunt/wiki/Sample-Gruntfile "Grunt's Gruntfile.js"
[ToDoApp]: https://github.com/thanpolas/todoAppMantri "The classical ToDo MVC app using Mantri's dependency management system"
